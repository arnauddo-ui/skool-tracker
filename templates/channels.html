{% extends "base.html" %}
{% block title %}Canaux ‚Äî Skool Tracker{% endblock %}
{% block content %}
<div class="filters" style="display:flex;gap:1rem;align-items:center;flex-wrap:wrap">
    <div class="filter-group"><label>P√©riode :</label>
        <select id="period"><option value="7">7j</option><option value="30" selected>30j</option><option value="90">90j</option><option value="365">1 an</option></select>
    </div>
    <div class="filter-group"><label>Vue :</label>
        <select id="viewMode">
            <option value="platform">Par plateforme</option>
            <option value="channel">Par lien</option>
        </select>
    </div>
</div>
<div class="kpi-grid" id="clickKpis"></div>
<div class="charts-grid">
    <div class="chart-card"><h3 id="pieTitle">R√©partition par plateforme</h3><canvas id="pieChart"></canvas></div>
    <div class="chart-card"><h3 id="lineTitle">√âvolution des clics</h3><canvas id="lineChart"></canvas></div>
</div>
<div class="card"><h3>üèÜ Classement</h3><div id="ranking" class="ranking-list"></div></div>
<div class="card" id="attributionCard" style="display:none">
    <h3>üéØ Attribution : canaux ‚Üí inscriptions</h3>
    <p class="text-muted" style="margin-bottom:1rem">Estimation bas√©e sur les clics dans les 48h pr√©c√©dant l'inscription d'un membre.</p>
    <div class="table-wrapper">
        <table>
            <thead><tr><th>Plateforme</th><th>Inscriptions attribu√©es</th><th>Dont payants</th><th>MRR g√©n√©r√©</th><th>LTV total</th><th>Taux conversion</th></tr></thead>
            <tbody id="attributionBody"></tbody>
        </table>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script>
// 20 distinct colors for channels
const PALETTE = [
    '#ff0033','#0077b5','#e1306c','#00f2ea','#1da1f2','#1877f2',
    '#f39c12','#34a853','#ff4500','#ff6719','#a29bfe','#00b894',
    '#fdcb6e','#e17055','#6c5ce7','#55efc4','#fab1a0','#74b9ff',
    '#ffeaa7','#dfe6e9'
];
const PLATFORM_COLORS = {
    'youtube':'#ff0033','linkedin':'#0077b5','instagram':'#e1306c',
    'tiktok':'#00f2ea','x':'#1da1f2','facebook':'#1877f2',
    'newsletter':'#f39c12','google-ads':'#34a853','reddit':'#ff4500',
    'substack':'#ff6719','linktree':'#43d172','direct':'#a29bfe',
    'podcast':'#e17055','autre':'#636e72'
};

function getColor(name, idx) {
    // Check platform colors first
    const base = name.split('-')[0];
    if (PLATFORM_COLORS[base]) return PLATFORM_COLORS[base];
    if (PLATFORM_COLORS[name]) return PLATFORM_COLORS[name];
    return PALETTE[idx % PALETTE.length];
}

let ch1, ch2;

async function load() {
    if(ch1) ch1.destroy();
    if(ch2) ch2.destroy();

    const days = document.getElementById('period').value;
    const view = document.getElementById('viewMode').value;
    const d = await (await fetch('/api/clicks?days=' + days)).json();

    const isPlatform = view === 'platform';
    const byData = isPlatform ? d.by_platform : d.by_channel;
    const dailyData = isPlatform ? d.daily_by_platform : d.daily_by_channel;
    const names = Object.keys(byData);
    const vals = Object.values(byData);
    const total = vals.reduce((a, b) => a + b, 0);

    document.getElementById('pieTitle').textContent = isPlatform ? 'R√©partition par plateforme' : 'R√©partition par lien';
    document.getElementById('lineTitle').textContent = '√âvolution des clics';

    // KPIs
    document.getElementById('clickKpis').innerHTML = `
        <div class="kpi-card"><div class="kpi-value">${total}</div><div class="kpi-label">Clics totaux</div></div>
        <div class="kpi-card"><div class="kpi-value">${names.length}</div><div class="kpi-label">${isPlatform ? 'Plateformes' : 'Liens'} actifs</div></div>
        <div class="kpi-card"><div class="kpi-value">${names[0] || '‚Äî'}</div><div class="kpi-label">Meilleur ${isPlatform ? 'plateforme' : 'lien'}</div></div>
    `;

    // Pie chart
    ch1 = new Chart('pieChart', {
        type: 'doughnut',
        data: {
            labels: names,
            datasets: [{
                data: vals,
                backgroundColor: names.map((n, i) => getColor(n, i)),
                borderWidth: 0
            }]
        },
        options: {
            responsive: true, cutout: '65%',
            plugins: {
                legend: {position: 'bottom', labels: {color: '#8b8fa3', font: {size: 12}}},
                tooltip: {
                    callbacks: {
                        label: ctx => ` ${ctx.label}: ${ctx.parsed} clics (${Math.round(ctx.parsed / total * 100)}%)`
                    }
                }
            }
        }
    });

    // Line chart with proper tooltips
    const allDays = Object.keys(dailyData).sort();
    const allNames = new Set();
    Object.values(dailyData).forEach(o => Object.keys(o).forEach(c => allNames.add(c)));

    ch2 = new Chart('lineChart', {
        type: 'line',
        data: {
            labels: allDays.map(d => d.slice(5)),
            datasets: [...allNames].map((name, i) => ({
                label: name,
                data: allDays.map(day => (dailyData[day] || {})[name] || 0),
                borderColor: getColor(name, i),
                backgroundColor: getColor(name, i) + '20',
                tension: 0.3,
                pointRadius: 3,
                pointHoverRadius: 6,
                borderWidth: 2
            }))
        },
        options: {
            responsive: true,
            interaction: { mode: 'index', intersect: false },
            plugins: {
                legend: {position: 'bottom', labels: {color: '#8b8fa3', font: {size: 11}, usePointStyle: true}},
                tooltip: {
                    mode: 'index', intersect: false,
                    callbacks: {
                        title: ctx => 'üìÖ ' + ctx[0].label,
                        label: ctx => ctx.parsed.y > 0 ? ` ${ctx.dataset.label}: ${ctx.parsed.y} clics` : null
                    },
                    filter: ctx => ctx.parsed.y > 0
                }
            },
            scales: {
                x: {grid: {color: 'rgba(45,49,72,0.5)'}, ticks: {color: '#5f637a'}},
                y: {beginAtZero: true, grid: {color: 'rgba(45,49,72,0.5)'}, ticks: {color: '#5f637a', precision: 0}}
            }
        }
    });

    // Ranking
    const mx = vals[0] || 1;
    document.getElementById('ranking').innerHTML = names.map((n, i) => `
        <div class="ranking-item">
            <div class="ranking-pos">#${i + 1}</div>
            <div class="ranking-channel"><span class="channel-badge" style="background:${getColor(n, i)}22;color:${getColor(n, i)};border:1px solid ${getColor(n, i)}44">${n}</span></div>
            <div class="ranking-bar-wrapper"><div class="ranking-bar" style="width:${byData[n] / mx * 100}%;background:${getColor(n, i)}"></div></div>
            <div class="ranking-count">${byData[n]} clics</div>
        </div>`).join('');

    // Attribution table
    const attr = d.attribution || {};
    const attrKeys = Object.keys(attr);
    if (attrKeys.length > 0) {
        document.getElementById('attributionCard').style.display = 'block';
        document.getElementById('attributionBody').innerHTML = attrKeys
            .sort((a, b) => attr[b].signups - attr[a].signups)
            .map(p => {
                const a = attr[p];
                const convRate = a.signups > 0 && d.by_platform[p] ? Math.round(a.signups / d.by_platform[p] * 100) : 0;
                return `<tr>
                    <td><span class="channel-badge" style="background:${getColor(p, 0)}22;color:${getColor(p, 0)}">${p}</span></td>
                    <td><strong>${a.signups}</strong></td>
                    <td>${a.paid}</td>
                    <td style="color:var(--success)">$${a.mrr}/mois</td>
                    <td>$${a.ltv}</td>
                    <td>${convRate}%</td>
                </tr>`;
            }).join('');
    } else {
        document.getElementById('attributionCard').style.display = 'none';
    }
}

document.getElementById('period').addEventListener('change', load);
document.getElementById('viewMode').addEventListener('change', load);
load();
</script>
{% endblock %}
