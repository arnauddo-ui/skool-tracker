{% extends "base.html" %}
{% block title %}Liens de tracking ‚Äî Skool Tracker{% endblock %}
{% block content %}
<div class="card">
    <h2>‚ûï Cr√©er un lien de tracking</h2>
    <form method="POST" style="display:flex;flex-direction:column;gap:0.75rem;margin-top:1rem">
        <div style="display:grid;grid-template-columns:1fr 1fr 2fr;gap:0.75rem">
            <div>
                <label style="color:var(--text-muted);font-size:0.85rem;margin-bottom:0.3rem;display:block">Plateforme</label>
                <select name="platform" style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text-primary);padding:0.6rem 1rem;border-radius:8px">
                    <option value="">‚Äî Choisir ‚Äî</option>
                    <option value="linkedin">LinkedIn</option>
                    <option value="youtube">YouTube</option>
                    <option value="instagram">Instagram</option>
                    <option value="tiktok">TikTok</option>
                    <option value="facebook">Facebook</option>
                    <option value="x">X (Twitter)</option>
                    <option value="newsletter">Newsletter</option>
                    <option value="google-ads">Google Ads</option>
                    <option value="reddit">Reddit</option>
                    <option value="substack">Substack</option>
                    <option value="linktree">Linktree</option>
                    <option value="podcast">Podcast</option>
                    <option value="autre">Autre</option>
                </select>
            </div>
            <div>
                <label style="color:var(--text-muted);font-size:0.85rem;margin-bottom:0.3rem;display:block">Nom du lien * <small>(unique)</small></label>
                <input type="text" name="link_name" placeholder="ex: arnaud, quentin, bio, post-jan..." required style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text-primary);padding:0.6rem 1rem;border-radius:8px">
            </div>
            <div>
                <label style="color:var(--text-muted);font-size:0.85rem;margin-bottom:0.3rem;display:block">URL de destination *</label>
                <input type="url" name="destination_url" placeholder="https://www.skool.com/..." required style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text-primary);padding:0.6rem 1rem;border-radius:8px">
            </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:0.75rem;align-items:end">
            <div>
                <label style="color:var(--text-muted);font-size:0.85rem;margin-bottom:0.3rem;display:block">UTM Source</label>
                <input type="text" name="utm_source" placeholder="ex: linkedin, youtube..." style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text-primary);padding:0.6rem 1rem;border-radius:8px">
            </div>
            <div>
                <label style="color:var(--text-muted);font-size:0.85rem;margin-bottom:0.3rem;display:block">UTM Campaign</label>
                <input type="text" name="utm_campaign" placeholder="ex: lancement-janvier, promo..." style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text-primary);padding:0.6rem 1rem;border-radius:8px">
            </div>
            <div>
                <button type="submit" class="btn btn-primary" style="width:100%;padding:0.6rem">Cr√©er le lien</button>
            </div>
        </div>
        <div id="previewUrl" style="color:var(--text-muted);font-size:0.85rem;margin-top:0.25rem"></div>
    </form>
</div>

<div class="card">
    <h2>üîó Vos liens de tracking ({{ links|length }})</h2>
    {% if links %}
    <div class="table-wrapper">
        <table>
            <thead><tr><th>Plateforme</th><th>Lien</th><th>URL de tracking</th><th>Destination</th><th>UTM Source</th><th>UTM Campaign</th><th>Clics</th><th>Actions</th></tr></thead>
            <tbody>
            {% for link in links %}
            <tr id="link-row-{{ link.id }}">
                <td><span class="channel-badge channel-{{ link.platform }}">{{ link.platform or '‚Äî' }}</span></td>
                <td><strong>{{ link.channel }}</strong></td>
                <td><code style="color:var(--accent);font-size:0.85rem;word-break:break-all" id="url-{{ link.channel }}">{{ link.url }}</code></td>
                <td style="font-size:0.85rem;max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="{{ link.destination_url }}">{{ link.destination_url }}</td>
                <td style="color:var(--text-muted)">{{ link.utm_source or '‚Äî' }}</td>
                <td style="color:var(--text-muted)">{{ link.utm_campaign or '‚Äî' }}</td>
                <td><strong>{{ link.clicks }}</strong></td>
                <td style="display:flex;gap:0.5rem">
                    <button class="btn btn-copy" onclick="copyLink('{{ link.channel }}')" title="Copier">üìã</button>
                    <button class="btn btn-danger-sm" onclick="deleteLink({{ link.id }}, '{{ link.channel }}')" title="Supprimer">üóëÔ∏è</button>
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p style="text-align:center;color:var(--text-muted);padding:2rem">Aucun lien cr√©√©. Utilisez le formulaire ci-dessus.</p>
    {% endif %}
</div>
{% endblock %}
{% block scripts %}
<script>
// Live URL preview
const platformSelect = document.querySelector('[name="platform"]');
const linkNameInput = document.querySelector('[name="link_name"]');
const preview = document.getElementById('previewUrl');

function updatePreview() {
    const p = platformSelect.value;
    const n = linkNameInput.value.toLowerCase().replace(/[^a-z0-9-_]/g, '');
    let slug = '';
    if (p && n) slug = p + '-' + n;
    else if (n) slug = n;
    else if (p) slug = p;
    if (slug) {
        preview.innerHTML = 'üîó URL g√©n√©r√©e : <strong style="color:var(--accent)">' + window.location.origin + '/go/' + slug + '</strong>';
    } else {
        preview.textContent = '';
    }
}
platformSelect.addEventListener('change', updatePreview);
linkNameInput.addEventListener('input', updatePreview);

function copyLink(ch) {
    navigator.clipboard.writeText(document.getElementById('url-'+ch).textContent).then(() => {
        event.target.textContent = '‚úÖ';
        setTimeout(() => event.target.textContent = 'üìã', 2000);
    });
}

function deleteLink(id, channel) {
    if (!confirm('‚ö†Ô∏è Supprimer le lien "' + channel + '" ?\n\nAttention : la suppression est D√âFINITIVE.\nToutes les donn√©es de clics associ√©es seront aussi supprim√©es.')) return;
    fetch('/api/links/' + id + '/delete', {method: 'POST'})
        .then(r => r.json())
        .then(d => {
            if (d.ok) document.getElementById('link-row-' + id).remove();
            else alert('Erreur: ' + (d.error || 'inconnue'));
        });
}
</script>
{% endblock %}
